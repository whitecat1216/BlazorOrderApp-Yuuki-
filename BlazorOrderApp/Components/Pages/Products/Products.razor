@page "/products"
@using BlazorOrderApp.Models
@using BlazorOrderApp.Repositories
@using System.Linq
@attribute [Authorize(Roles = "Administrator")]
@inherits BlazorOrderApp.Components.Commons.InitialFocusComponent

<h3>商品マスタ一覧</h3>

<div class="mb-3 d-flex align-items-end">
    <div>
        <input type="text" class="form-control" placeholder="キーワード（商品コード／商品名）"
               @bind="keyword" @bind:event="oninput" style="width: 300px; display:inline-block;"
               data-tab="10" />
    </div>
    <button class="btn btn-primary ms-2" @onclick="Search">検索</button>

    <button class="btn btn-success ms-auto" @onclick="OnAdd">＋追加</button>
</div>

<table class="table table-striped table-bordered table-sm">
    <thead class="custom-header">
        <tr>
            <th class="text-center sortable-header" style="width:20%"
                @onclick="@(() => ToggleSort("商品コード"))">
                <span>商品コード</span>
                <span class="sort-icon">@GetSortIcon("商品コード")</span>
            </th>
            <th class="text-center sortable-header" style="width:50%"
                @onclick="@(() => ToggleSort("商品名"))">
                <span>商品名</span>
                <span class="sort-icon">@GetSortIcon("商品名")</span>
            </th>
            <th class="text-center sortable-header" style="width:15%"
                @onclick="@(() => ToggleSort("単価"))">
                <span>単価</span>
                <span class="sort-icon">@GetSortIcon("単価")</span>
            </th>
            <th class="text-center" style="width:15%">操作</th>
        </tr>
    </thead>
    <tbody>
        @if (!表示一覧.Any())
        {
            <tr><td colspan="4">該当する商品がありません。</td></tr>
        }
        else
        {
            <Virtualize Context="row" Items="@表示一覧" OverscanCount="5" SpacerElement="tr">
                <tr>
                    <td>@row.商品コード</td>
                    <td>@row.商品名</td>
                    <td class="text-end pe-3">¥@row.単価?.ToString("#,##0")</td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-outline-primary" @onclick="() => OnEdit(row.商品コード)">
                            修正・確認
                        </button>
                    </td>
                </tr>
            </Virtualize>
        }
    </tbody>
</table>

<style>
    .sortable-header {
        cursor: pointer;
        user-select: none;
        white-space: nowrap;
    }

    .sort-icon {
        margin-left: 4px;
    }
</style>



@code {
    [Inject]
    private NavigationManager Navigation { get; set; } = default!;
    [Inject]
    public IProductRepository 商品Repository { get; set; } = default!;

    [Parameter, SupplyParameterFromQuery]
    public string keyword { get; set; } = string.Empty;
    [Parameter, SupplyParameterFromQuery]
    public string SortColumn { get; set; } = "商品コード";
    [Parameter, SupplyParameterFromQuery]
    public string SortDirection { get; set; } = "asc";

    private List<ProductModel>? 商品一覧;
    private List<ProductModel> 表示一覧 = new();  // 絞り込みでフィルターされる

    protected override async Task OnInitializedAsync()
    {
        商品一覧 = (await 商品Repository.GetAllAsync()).ToList();
        // 初期表示
        Search();
    }

    private void Search()
    {
        IEnumerable<ProductModel> query = 商品一覧 ?? Enumerable.Empty<ProductModel>();

        if (!string.IsNullOrWhiteSpace(keyword))
        {
            var k = keyword.Trim();
            query = query.Where(x => (x.商品コード?.Contains(k) ?? false)
                                  || (x.商品名?.Contains(k) ?? false));
        }

        表示一覧 = query.ToList();
        ApplySort();
    }

    private void ToggleSort(string column)
    {
        if (string.Equals(SortColumn, column, StringComparison.Ordinal))
        {
            SortDirection = string.Equals(SortDirection, "desc", StringComparison.OrdinalIgnoreCase)
                ? "asc"
                : "desc";
        }
        else
        {
            SortColumn = column;
            SortDirection = column == "単価" ? "desc" : "asc";
        }

        ApplySort();
    }

    private void ApplySort()
    {
        if (表示一覧.Count <= 1)
        {
            return;
        }

        var descending = string.Equals(SortDirection, "desc", StringComparison.OrdinalIgnoreCase);

        IEnumerable<ProductModel> sorted = SortColumn switch
        {
            "商品名" => descending
                ? 表示一覧.OrderByDescending(p => p.商品名)
                : 表示一覧.OrderBy(p => p.商品名),
            "単価" => descending
                ? 表示一覧.OrderByDescending(p => p.単価 ?? 0m)
                : 表示一覧.OrderBy(p => p.単価 ?? 0m),
            _ => descending
                ? 表示一覧.OrderByDescending(p => p.商品コード)
                : 表示一覧.OrderBy(p => p.商品コード)
        };

        表示一覧 = sorted.ToList();
    }

    private string GetSortIcon(string column)
    {
        if (!string.Equals(SortColumn, column, StringComparison.Ordinal))
        {
            return string.Empty;
        }

        return string.Equals(SortDirection, "asc", StringComparison.OrdinalIgnoreCase) ? "▲" : "▼";
    }

    private string BuildQueryString()
    {
        var query = new List<string>();

        if (!string.IsNullOrWhiteSpace(keyword))
        {
            query.Add($"keyword={Uri.EscapeDataString(keyword)}");
        }

        query.Add($"SortColumn={Uri.EscapeDataString(SortColumn ?? "商品コード")}");
        query.Add($"SortDirection={Uri.EscapeDataString(SortDirection ?? "asc")}");

        return query.Count > 0 ? "?" + string.Join("&", query) : string.Empty;
    }

    private void OnAdd()
    {
        Navigation.NavigateTo("/products/edit" + BuildQueryString());
    }

    private void OnEdit(string 商品コード)
    {
        Navigation.NavigateTo($"/products/edit/{商品コード}{BuildQueryString()}");
    }
}